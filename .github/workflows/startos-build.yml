name: Build StartOS Package

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version to build (e.g., 0.1.0)"
        required: true
        default: "0.1.0"

permissions:
  contents: write

jobs:
  build-startos:
    name: Build StartOS Package (v1)
    runs-on: ubuntu-latest
    steps:
      - name: Setup StartOS SDK
        uses: Start9Labs/sdk@v1

      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialize SDK
        run: start-sdk init

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Prepare StartOS build context
        run: |
          # Copy StartOS assets to project root (Dockerfile expects app/ paths)
          cp platforms/startos/manifest.yaml .
          cp platforms/startos/Dockerfile .
          cp platforms/startos/LICENSE .
          cp platforms/startos/icon.png .
          cp platforms/startos/instructions.md .
          cp platforms/startos/entrypoint.sh .
          cp -r platforms/startos/scripts .

      - name: Build x86_64 Docker image
        run: |
          mkdir -p docker-images
          docker buildx build \
            --tag start9/roostr/main:${{ github.event.inputs.version }} \
            --platform=linux/amd64 \
            -o type=docker,dest=docker-images/x86_64.tar \
            .

      - name: Build aarch64 Docker image
        run: |
          docker buildx build \
            --tag start9/roostr/main:${{ github.event.inputs.version }} \
            --platform=linux/arm64 \
            -o type=docker,dest=docker-images/aarch64.tar \
            .

      - name: Build StartOS package
        run: start-sdk pack

      - name: Verify package
        run: start-sdk verify s9pk roostr.s9pk

      - name: Generate checksum
        run: sha256sum roostr.s9pk > roostr.s9pk.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: startos-package-v1
          path: |
            roostr.s9pk
            roostr.s9pk.sha256

      - name: Upload to release
        if: github.event.inputs.version != ''
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ github.event.inputs.version }}
          files: |
            roostr.s9pk
            roostr.s9pk.sha256
        continue-on-error: true
